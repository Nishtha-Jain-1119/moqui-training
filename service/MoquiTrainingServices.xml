<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">
    <service verb="create" noun="MoquiTraining" type="entity-auto" >
        <in-parameters>
            <auto-parameters include="nonpk"/>
            <parameter name="trainingName" required="true"/>
            <parameter name="trainingDate" format="dd/mm/yyyy"/>
            <parameter name="trainingPrice"><number-integer/></parameter>
            <parameter name="trainingDuration"><number-integer/></parameter>
        </in-parameters>
        <out-parameters>
            <auto-parameters include="pk" required="true"/>
        </out-parameters>
    </service>

    <service verb="create" displayName="Create a MoquiTraining" noun="MoquiTrainingInline">
        <in-parameters>
            <auto-parameters entity-name="moqui.training.MoquiTraining" include="nonpk"/>
            <parameter name="trainingId_New"/>
            <parameter name="trainingName" required="true"/>
<!--            <parameter name="trainingDate"><matches regexp="(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[1,2])\/(19|20)\d{2}" message="Format is DD/MM/YYYY"/></parameter>-->
        </in-parameters>
        <out-parameters>
            <parameter name="trainingId"/>
        </out-parameters>
        <actions>
            <log message="==before========${context}====================="/>
            <service-call name="create#moqui.training.MoquiTraining" in-map="context+[trainingId: trainingId_New]" out-map="context"/>
            <log message="==after========${context.trainingId}====================="/>
        </actions>
    </service>

    <service verb="create" noun="MoquiTrainingGroovy" type="script"
             location="component://moqui-training/service/createMoquiTraining.groovy">
        <in-parameters>
            <auto-parameters entity-name="moqui.training.MoquiTraining" include="nonpk"/>
            <parameter name="trainingName" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="trainingId" required="true"/>
        </out-parameters>
    </service>

    <service verb="get" noun="MoquiTraining">
        <in-parameters>
            <parameter name="trainingId"/>
            <parameter name="trainingName"/>
        </in-parameters>
        <out-parameters>
            <parameter name="moquiTrainingList"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="moqui.training.MoquiTraining" list="moquiTrainingList">
                <econditions combine="or">
                    <econdition field-name="trainingId" value="${trainingId}"/>
                    <econdition field-name="trainingName" value="${trainingName}"/>
                </econditions>
                <select-field field-name="trainingId,trainingName,trainingDate"/>
            </entity-find>
        </actions>
    </service>

    <service verb="store" noun="MoquiTraining">
        <in-parameters>
            <auto-parameters entity-name="moqui.training.MoquiTraining"/>
            <parameter name="trainingDate" format="dd/mm/yyyy"/>
            <parameter name="trainingPrice"><number-integer/></parameter>
            <parameter name="trainingDuration"><number-integer/></parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="trainingId"/>
        </out-parameters>
        <actions>
            <if condition="trainingId &amp;&amp; trainingName">
                <entity-find entity-name="moqui.training.MoquiTraining" list="existingMoquiTraining">
                    <econditions>
                        <econdition field-name="trainingId" value="${trainingId}"/>
                        <econdition field-name="trainingName" value="${trainingName}"/>
                    </econditions>
                </entity-find>
                <if condition="existingMoquiTraining"><then>
                    <service-call name="update#moqui.training.MoquiTraining" in-map="context" out-map="context"/>
                    </then>
                <else>
                    <service-call name="create#moqui.training.MoquiTraining" in-map="context" out-map="context"/>
                </else>
                </if>
            </if>
            <if condition="!trainingName &amp;&amp; trainingId">
                <entity-find-one entity-name="moqui.training.MoquiTraining" value-field="existingMoquiTraining">
                    <field-map field-name="trainingId" value="${trainingId}"/>
                </entity-find-one>
                <if condition="existingMoquiTraining">
                    <service-call name="update#moqui.training.MoquiTraining" in-map="context" out-map="context"/>
                    <else>
                        <message error="true">Can't create records without trainingName</message>
                    </else>
                </if>
            </if>
            <if condition="trainingName &amp;&amp; !trainingId">
                <entity-find entity-name="moqui.training.MoquiTraining" list="existingMoquiTraining">
                    <econditions>
                        <econdition field-name="trainingName" value="${trainingName}"/>
                    </econditions>
                </entity-find>
                <if condition="existingMoquiTraining">
                    <then>
                        <set field="trainingId" from="existingMoquiTraining?.first?.trainingId"/>
                        <service-call name="update#moqui.training.MoquiTraining" in-map="context" out-map="context"/>
                    </then>
                    <else>
                        <service-call name="create#moqui.training.MoquiTraining" in-map="context" out-map="context"/>
                    </else>
                </if>
            </if>
        </actions>
    </service>
</services>